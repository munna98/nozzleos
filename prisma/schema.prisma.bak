// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model UserRole {
  id    Int    @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  name         String?
  passwordHash String
  code         String?
  mobile       String?
  isActive     Boolean  @default(true)
  address      String?
  roleId       Int
  role         UserRole @relation(fields: [roleId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?
  
  // Shift Management
  dutySessions      DutySession[]  @relation("UserSessions")
  verifiedSessions  DutySession[]  @relation("VerifiedSessions")
  
  @@index([roleId, isActive])
  @@index([isActive])
}

model Customer {
  id            Int            @id @default(autoincrement())
  name          String
  email         String?        @unique
  phone         String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  paymentMethod PaymentMethod?
  
  @@index([isActive])
  @@index([phone])
}

model PaymentMethod {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  isActive        Boolean          @default(true)
  customerId      Int?             @unique
  customer        Customer?        @relation(fields: [customerId], references: [id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  sessionPayments SessionPayment[]
  
  @@index([isActive])
}

model Fuel {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  price     Float     @default(0)
  isActive  Boolean   @default(true)
  nozzles   Nozzle[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  
  @@index([isActive])
}

model Dispenser {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  name      String
  isActive  Boolean   @default(true)
  nozzles   Nozzle[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  
  @@index([isActive])
}

model Nozzle {
  id             Int       @id @default(autoincrement())
  code           String    @unique
  dispenserId    Int
  dispenser      Dispenser @relation(fields: [dispenserId], references: [id])
  fuelId         Int
  fuel           Fuel      @relation(fields: [fuelId], references: [id])
  price          Float     @default(0)
  currentreading Float     @default(0)
  isActive       Boolean   @default(true)
  isAvailable    Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  nozzleSessionReadings NozzleSessionReading[]
  
  @@index([isActive, isAvailable])
  @@index([dispenserId])
  @@index([fuelId])
}

enum ShiftType {
  MORNING
  EVENING
  NIGHT
}

// Shift Management Models
model DutySession {
  id                    Int                    @id @default(autoincrement())
  userId                Int
  user                  User                   @relation("UserSessions", fields: [userId], references: [id])
  type                  ShiftType              @default(MORNING)
  startTime             DateTime               @default(now())
  endTime               DateTime?
  status                String                 @default("in_progress")  // in_progress, pending_verification, verified, rejected
  totalPaymentCollected Decimal                @default(0) @db.Decimal(10, 2)
  notes                 String?                @db.Text
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  
  // Verification fields
  verifiedAt            DateTime?
  verifiedByUserId      Int?
  verifiedBy            User?                  @relation("VerifiedSessions", fields: [verifiedByUserId], references: [id])
  rejectionNotes        String?                @db.Text

  nozzleReadings        NozzleSessionReading[]
  sessionPayments       SessionPayment[]
  
  @@index([userId, status])
  @@index([status, endTime])
  @@index([userId, endTime])
  @@index([createdAt])
}

model NozzleSessionReading {
  id             Int         @id @default(autoincrement())
  dutySessionId  Int
  dutySession    DutySession @relation(fields: [dutySessionId], references: [id], onDelete: Cascade)
  nozzleId       Int
  nozzle         Nozzle      @relation(fields: [nozzleId], references: [id])
  openingReading Decimal     @db.Decimal(10, 2)
  testQty        Decimal     @default(0) @db.Decimal(10, 2)
  closingReading Decimal?    @db.Decimal(10, 2)
  fuelDispensed  Decimal     @default(0) @db.Decimal(10, 2)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  @@index([dutySessionId])
  @@index([nozzleId])
}

model SessionPayment {
  id              Int           @id @default(autoincrement())
  dutySessionId   Int
  dutySession     DutySession   @relation(fields: [dutySessionId], references: [id], onDelete: Cascade)
  paymentMethodId Int
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  amount          Decimal       @db.Decimal(10, 2)
  quantity        Int?
  coinsAmount     Decimal?      @db.Decimal(10, 2)  // Lump sum for coins
  createdAt       DateTime      @default(now())
  
  denominations   PaymentDenomination[]
  
  @@index([dutySessionId])
  @@index([paymentMethodId])
  @@index([createdAt])
}

// Global app settings (single row pattern)
model Settings {
  id                      Int      @id @default(1)
  enableDenominationEntry Boolean  @default(true)  // Show denomination grid for cash
  enableCoinEntry         Boolean  @default(true)  // Show coins lump sum field
  updatedAt               DateTime @updatedAt
}

// Available currency denominations (notes only)
model Denomination {
  id        Int     @id @default(autoincrement())
  value     Int     @unique  // 2000, 500, 200, 100, 50, 20, 10
  label     String  // "₹2000", "₹500", etc.
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)
  
  paymentDenominations PaymentDenomination[]
  
  @@index([sortOrder])
  @@index([isActive])
}

// Junction table: which denominations were used in a payment
model PaymentDenomination {
  id               Int            @id @default(autoincrement())
  sessionPaymentId Int
  sessionPayment   SessionPayment @relation(fields: [sessionPaymentId], references: [id], onDelete: Cascade)
  denominationId   Int
  denomination     Denomination   @relation(fields: [denominationId], references: [id])
  count            Int            @default(0)
  
  @@unique([sessionPaymentId, denominationId])
}

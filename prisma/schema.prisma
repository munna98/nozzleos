generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model UserRole {
  id    Int    @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id                    Int                @id @default(autoincrement())
  username              String             @unique
  name                  String?
  passwordHash          String
  code                  String?
  mobile                String?
  isActive              Boolean            @default(true)
  address               String?
  roleId                Int
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  deletedAt             DateTime?
  dutySessions          DutySession[]      @relation("UserSessions")
  verifiedSessions      DutySession[]      @relation("VerifiedSessions")
  initiatedEditRequests ShiftEditRequest[] @relation("EditRequestInitiatedBy")
  approvedEditRequests  ShiftEditRequest[] @relation("EditRequestApprovedBy")
  role                  UserRole           @relation(fields: [roleId], references: [id])

  @@index([roleId, isActive])
  @@index([isActive])
}

model Customer {
  id            Int            @id @default(autoincrement())
  name          String
  email         String?        @unique
  phone         String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?
  paymentMethod PaymentMethod?

  @@index([isActive])
  @@index([phone])
}

model PaymentMethod {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  isActive        Boolean          @default(true)
  customerId      Int?             @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  customer        Customer?        @relation(fields: [customerId], references: [id])
  sessionPayments SessionPayment[]

  @@index([isActive])
}

model Fuel {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  price     Float     @default(0)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  nozzles   Nozzle[]

  @@index([isActive])
}

model Dispenser {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  name      String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  nozzles   Nozzle[]

  @@index([isActive])
}

model Nozzle {
  id                    Int                    @id @default(autoincrement())
  code                  String                 @unique
  dispenserId           Int
  fuelId                Int
  price                 Float                  @default(0)
  currentreading        Float                  @default(0)
  isActive              Boolean                @default(true)
  isAvailable           Boolean                @default(true)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  deletedAt             DateTime?
  dispenser             Dispenser              @relation(fields: [dispenserId], references: [id])
  fuel                  Fuel                   @relation(fields: [fuelId], references: [id])
  nozzleSessionReadings NozzleSessionReading[]

  @@index([isActive, isAvailable])
  @@index([dispenserId])
  @@index([fuelId])
}

model DutySession {
  id                    Int                    @id @default(autoincrement())
  userId                Int
  type                  ShiftType              @default(MORNING)
  startTime             DateTime               @default(now())
  endTime               DateTime?
  status                String                 @default("in_progress")
  totalPaymentCollected Decimal                @default(0) @db.Decimal(10, 2)
  notes                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  verifiedAt            DateTime?
  verifiedByUserId      Int?
  rejectionNotes        String?
  user                  User                   @relation("UserSessions", fields: [userId], references: [id])
  verifiedBy            User?                  @relation("VerifiedSessions", fields: [verifiedByUserId], references: [id])
  nozzleReadings        NozzleSessionReading[]
  sessionPayments       SessionPayment[]
  editRequests          ShiftEditRequest[]

  @@index([userId, status])
  @@index([status, endTime])
  @@index([userId, endTime])
  @@index([createdAt])
}

model NozzleSessionReading {
  id             Int         @id @default(autoincrement())
  dutySessionId  Int
  nozzleId       Int
  openingReading Decimal     @db.Decimal(10, 2)
  testQty        Decimal     @default(0) @db.Decimal(10, 2)
  closingReading Decimal?    @db.Decimal(10, 2)
  fuelDispensed  Decimal     @default(0) @db.Decimal(10, 2)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  dutySession    DutySession @relation(fields: [dutySessionId], references: [id], onDelete: Cascade)
  nozzle         Nozzle      @relation(fields: [nozzleId], references: [id])

  @@index([dutySessionId])
  @@index([nozzleId])
}

model SessionPayment {
  id              Int                   @id @default(autoincrement())
  dutySessionId   Int
  paymentMethodId Int
  amount          Decimal               @db.Decimal(10, 2)
  quantity        Int?
  coinsAmount     Decimal?              @db.Decimal(10, 2)
  createdAt       DateTime              @default(now())
  denominations   PaymentDenomination[]
  dutySession     DutySession           @relation(fields: [dutySessionId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod         @relation(fields: [paymentMethodId], references: [id])

  @@index([dutySessionId])
  @@index([paymentMethodId])
  @@index([createdAt])
}

model Settings {
  id                      Int      @id @default(1)
  enableDenominationEntry Boolean  @default(true)
  enableCoinEntry         Boolean  @default(true)
  updatedAt               DateTime @updatedAt
}

model Denomination {
  id                   Int                   @id @default(autoincrement())
  value                Int                   @unique
  label                String
  isActive             Boolean               @default(true)
  sortOrder            Int                   @default(0)
  paymentDenominations PaymentDenomination[]

  @@index([sortOrder])
  @@index([isActive])
}

model PaymentDenomination {
  id               Int            @id @default(autoincrement())
  sessionPaymentId Int
  denominationId   Int
  count            Int            @default(0)
  denomination     Denomination   @relation(fields: [denominationId], references: [id])
  sessionPayment   SessionPayment @relation(fields: [sessionPaymentId], references: [id], onDelete: Cascade)

  @@unique([sessionPaymentId, denominationId])
}

model ShiftEditRequest {
  id                Int       @id @default(autoincrement())
  dutySessionId     Int
  dutySession       DutySession @relation(fields: [dutySessionId], references: [id], onDelete: Cascade)
  requestedByUserId Int
  requestedByUser   User      @relation("EditRequestInitiatedBy", fields: [requestedByUserId], references: [id])
  reason            String
  status            String    @default("pending") // "pending" | "approved"
  approvedByUserId  Int?
  approvedByUser    User?     @relation("EditRequestApprovedBy", fields: [approvedByUserId], references: [id])
  approvedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  @@index([dutySessionId])
  @@index([status])
}

enum ShiftType {
  MORNING
  EVENING
  NIGHT
}
